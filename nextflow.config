manifest {
  name = 'ngs_variant_calling_nextflow'
  version = '0.1.0'
  nextflowVersion = '>=25.10.4'
}

params {
  help = false
  sif = '../../WGS_Variant_Calling.sif'

  input_dir = null
  ref = null
  read_type = 'PE'
  caller = 'bcftools'
  use_bqsr = false
  run_step = 'all'
  fastp_parameters = ''
  bwa_parameters = ''
  bwamem2_parameters = ''
  bcftools_mpileup_parameters = ''
  bcftools_call_parameters = ''
  bcftools_concat_parameters = ''
  gatk_haplotypecaller_parameters = ''
  gatk_genomicsdbimport_parameters = ''
  gatk_genotypegvcfs_parameters = ''
  gatk_baserecalibrator_parameters = ''
  gatk_applybqsr_parameters = ''
  gatk_variantfiltration_snp_parameters = ''
  gatk_variantfiltration_indel_parameters = ''
  threads = 4

  // Optional scheduler / cloud params
  slurm_queue = null
  slurm_account = null
  slurm_qos = null
  slurm_time = null
  slurm_constraint = null
  slurm_extra = null
  slurm_queue_size = 20

  aws_region = 'us-east-1'
  aws_queue = null
  aws_workdir = null
  aws_container = null
  aws_cli_path = null

  fastqc_cpus = null
  fastp_cpus = null
  bwa_cpus = null
  bwamem2_cpus = null
  sambamba_cpus = null
  bcftools_cpus = null
  gatk_cpus = null
}

process {
  errorStrategy = 'terminate'
  shell = ['/bin/bash', '-euo', 'pipefail']
}

singularity {
  enabled = false
  autoMounts = true
}

apptainer {
  enabled = true
  autoMounts = true
}

profiles {
  local {
    process.executor = 'local'
    workDir = 'work'
  }

  slurm {
    process.executor = 'slurm'
    process.queue = params.slurm_queue
    process.clusterOptions = [
      params.slurm_account ? "--account=${params.slurm_account}" : null,
      params.slurm_qos ? "--qos=${params.slurm_qos}" : null,
      params.slurm_constraint ? "--constraint=${params.slurm_constraint}" : null,
      params.slurm_extra ? "${params.slurm_extra}" : null
    ].findAll { it }.join(' ')
    process.time = params.slurm_time
    executor.queueSize = params.slurm_queue_size
    workDir = 'work'
  }

  awsbatch {
    process.executor = 'awsbatch'
    process.queue = params.aws_queue
    docker.enabled = true
    apptainer.enabled = false
    singularity.enabled = false
    aws.region = params.aws_region
    aws.batch.cliPath = params.aws_cli_path
    // On AWS Batch, pass a docker image via --aws_container and reuse process container setting via params.sif
    params.sif = params.aws_container ?: params.sif
    workDir = params.aws_workdir ?: 's3://CHANGE_ME_NF_WORKDIR/work'
  }
}

timeline {
  enabled = true
  file = 'pipeline_info/timeline.html'
  overwrite = true
}

report {
  enabled = true
  file = 'pipeline_info/report.html'
  overwrite = true
}

trace {
  enabled = true
  file = 'pipeline_info/trace.txt'
  overwrite = true
}

dag {
  enabled = true
  file = 'pipeline_info/dag.html'
  overwrite = true
}
